import{z as e,A as t,j as s,k as i,E as o,l as a,r as n,o as l,c as r,w as d,a as c,d as u,t as h,m as g,F as f,p as _,v as p,G as m,g as y,f as b,n as w,b as k,e as I,H as v,x as C}from"./index-mx_jV9ub.js";import{r as x,_ as L}from"./uni-app.es.Cu18BVUg.js";import{_ as $}from"./uni-popup.CapNXNO4.js";import{_ as S}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{_ as F}from"./cloud-image.BmK_G5C2.js";import{_ as E,a as A}from"./uni-list.Dyk35lvO.js";import{s as R}from"./store.CwO1uWiY.js";const B="RewardedVideo",D="FullScreenVideo";const T="csj";class M{constructor(e,t={}){this._isLoad=!1,this._isLoading=!1,this._lastLoadTime=0,this._lastError=null,this._retryCount=0,this._loadCallback=null,this._closeCallback=null,this._errorCallback=null;const s=this._ad=e;s.onLoad((e=>{this._isLoading=!1,this._isLoad=!0,this._lastLoadTime=Date.now(),this.onLoad()})),s.onClose((e=>{this._isLoad=!1,this.onClose(e)})),s.onVerify&&s.onVerify((e=>{})),s.onError((({code:e,message:t})=>{this._isLoading=!1;const s={code:e,errMsg:t};if(-5008!==e){if(this._retryCount<1)return this._retryCount+=1,void this._loadAd();this._lastError=s,this.onError(s)}else this._loadAd()}))}get isExpired(){return 0!==this._lastLoadTime&&Math.abs(Date.now()-this._lastLoadTime)>18e5}get isLoading(){return this._isLoading}getProvider(){return this._ad.getProvider()}load(e,t){this._loadCallback=e,this._errorCallback=t,this._isLoading||(this._isLoad?this.onLoad():(this._retryCount=0,this._loadAd()))}show(e){if(this._closeCallback=e,this._isLoading||!this._isLoad)return;if(null!==this._lastError)return void this.onError(this._lastError);this.getProvider()===T&&this.isExpired?this._loadAd():this._ad.show()}onLoad(e){null!=this._loadCallback&&this._loadCallback()}onClose(e){null!=this._closeCallback&&this._closeCallback({isEnded:e.isEnded})}onError(e){null!=this._errorCallback&&this._errorCallback(e)}destroy(){this._ad.destroy()}_loadAd(){this._isLoad=!1,this._isLoading=!0,this._lastError=null,this._ad.load()}}class j extends M{constructor(e={}){super(plus.ad.createRewardedVideoAd(e),e)}}class V extends M{constructor(e={}){super(plus.ad.createFullScreenVideoAd(e),e)}}const N=new class{constructor(){this._ads={}}load(e,t,s){let i=this._fixOldOptions(e),{adpid:o}=i;o&&!this.isBusy(o)&&this.get(i).load(t,s)}show(s,i,o){let a=this._fixOldOptions(s),{adpid:n}=a;if(n){e({mask:!0});var l=this.get(a);l.load((()=>{t(),l.show((e=>{i&&i(e)}))}),(e=>{t(),o&&o(e)}))}}isBusy(e){return this._ads[e]&&this._ads[e].isLoading}get(e){const{adpid:t,singleton:s=!0}=e;return!1===s&&this._ads[t]&&(this._ads[t].destroy(),delete this._ads[t]),delete e.singleton,this._ads[t]||(this._ads[t]=this._createAdInstance(e)),this._ads[t]}_createAdInstance(e){const t=e.adType||B;delete e.adType;let s=null;return t===B?s=new j(e):t===D&&(s=new V(e)),s}_fixOldOptions(e){return"string"==typeof e?{adpid:e}:e}},z=s.database().action("signIn").collection("opendb-sign-in");new Date((new Date).toLocaleDateString()).getTime();const q=S({name:"uni-signIn",data:()=>({total:0,scores:0,weekdays:[1,2,3,4,5,6,7],signInRes:{days:[],n:0}}),mounted(){},methods:{async getSignedInInfo(e="今日已签过"){const t=new Date((new Date).toLocaleDateString()).getTime();let s=await z.where(`'user_id' == $env.uid && 'date' == ${t} && 'isDelete' == false`).get();return s.result.data.length&&(this.signInRes=s.result,this.$refs.popup.open(),i({title:e,duration:3e3,icon:"none"})),s.result.data},async showRewardedVideoAd(){let s=await this.getSignedInInfo();if(console.log(s),s&&0==s.length){let{_id:s}=o("userInfo");if(console.log(s,o("userInfo")),!s)return a({url:"/pages/ucenter/login-page/index/index"});N.show({adpid:1733738477,adType:"RewardedVideo",urlCallback:{userId:s,extra:"uniSignIn"}},(s=>{if(s&&s.isEnded){console.log("onClose "+s.isEnded);let o=0;e({mask:!0});let a=setInterval((async e=>{o++,s=await this.getSignedInInfo("签到成功"),(o>2||s.length)&&(s.length||i({title:"签到失败！",icon:"error",duration:6e3}),clearInterval(a),t())}),2e3)}else console.log("onClose "+s.isEnded),i({title:"播放中途退出,签到失败！",icon:"error",duration:5e3})}),(e=>{console.log(e),i({title:e.errMsg,icon:"none"})}))}},async open(){e({mask:!0});try{let e=await this.getSignedInInfo();if(e&&0==e.length){let e=await z.add({});console.log(e),t(),this.signInRes=e.result,this.$refs.popup.open(),7==this.signInRes.days.length?i({title:"你已完成7日连续签到，获得60积分！",icon:"none",duration:5e3}):i({title:"签到成功,获得10积分！",icon:"none",duration:5e3})}}catch(s){t(),console.error(s)}},closeMe(e){this.$refs.popup.close()}}},[["render",function(e,t,s,i,o,a){const w=m,k=y,I=b,v=x(n("uni-icons"),L),C=x(n("uni-popup"),$);return l(),r(I,null,{default:d((()=>[c(C,{ref:"popup",type:"center"},{default:d((()=>[c(w,{class:"background-img",src:"/assets/background-Bu1oXiEy.png",mode:"width"}),c(I,{class:"content"},{default:d((()=>[c(I,{class:"main"},{default:d((()=>[c(k,{class:"title"},{default:d((()=>[u("今日签到成功")])),_:1}),c(k,{class:"total"},{default:d((()=>[u("本轮已签到"+h(o.signInRes.days.length)+"天",1)])),_:1}),c(k,{class:"scores"},{default:d((()=>[u("当前积分："+h(o.signInRes.score),1)])),_:1})])),_:1}),c(I,null,{default:d((()=>[c(I,{class:"days-box"},{default:d((()=>[(l(!0),g(f,null,_(o.weekdays,((e,t)=>(l(),r(I,{class:"days",key:t},{default:d((()=>[o.signInRes.days.includes(e-1)?(l(),r(v,{key:0,class:"icon active",color:"#FFFFFF",type:"checkmarkempty"})):(l(),g(f,{key:1},[e<o.signInRes.n?(l(),r(v,{key:0,class:"icon active",color:"#FFFFFF",type:"closeempty"})):(l(),r(v,{key:1,class:"icon",type:"checkmarkempty",color:"#FFFFFF"}))],64)),o.signInRes.days.includes(e-1)||e>o.signInRes.n?(l(),r(k,{key:2,class:p(["day",{grey:e>o.signInRes.n}])},{default:d((()=>[u("第"+h(e)+"天",1)])),_:2},1032,["class"])):(l(),r(k,{key:3,class:"day"},{default:d((()=>[u("缺卡")])),_:1}))])),_:2},1024)))),128))])),_:1}),c(I,{class:"tip-box"},{default:d((()=>[c(k,{class:"tip"},{default:d((()=>[u("签到一次得10积分")])),_:1}),c(I,{class:"row"},{default:d((()=>[c(k,{class:"tip"},{default:d((()=>[u("连续签到7天可多得")])),_:1}),c(k,{class:"red"},{default:d((()=>[u("50")])),_:1}),c(k,{class:"tip"},{default:d((()=>[u("积分")])),_:1})])),_:1})])),_:1})])),_:1}),c(v,{onClick:a.closeMe,class:"close-icon",type:"closeempty",size:"20",color:"#AAAAAA"},null,8,["onClick"])])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-26f1750b"]]);const O=S({name:"UniGridItem",inject:["grid"],props:{index:{type:Number,default:0}},data:()=>({column:0,showBorder:!0,square:!0,highlight:!0,left:0,top:0,openNum:2,width:0,borderColor:"#e5e5e5"}),created(){this.column=this.grid.column,this.showBorder=this.grid.showBorder,this.square=this.grid.square,this.highlight=this.grid.highlight,this.top=0===this.hor?this.grid.hor:this.hor,this.left=0===this.ver?this.grid.ver:this.ver,this.borderColor=this.grid.borderColor,this.grid.children.push(this),this.width=this.grid.width},beforeDestroy(){this.grid.children.forEach(((e,t)=>{e===this&&this.grid.children.splice(t,1)}))},methods:{_onClick(){this.grid.change({detail:{index:this.index}})}}},[["render",function(e,t,s,i,o,a){const n=b;return o.width?(l(),r(n,{key:0,style:w("width:"+o.width+";"+(o.square?"height:"+o.width:"")),class:"uni-grid-item"},{default:d((()=>[c(n,{class:p([{"uni-grid-item--border":o.showBorder,"uni-grid-item--border-top":o.showBorder&&s.index<o.column,"uni-highlight":o.highlight},"uni-grid-item__box"]),style:w({"border-right-color":o.borderColor,"border-bottom-color":o.borderColor,"border-top-color":o.borderColor}),onClick:a._onClick},{default:d((()=>[k(e.$slots,"default",{},void 0,!0)])),_:3},8,["class","style","onClick"])])),_:3},8,["style"])):I("",!0)}],["__scopeId","data-v-1f1eb9ce"]]);const U=S({name:"UniGrid",emits:["change"],props:{column:{type:Number,default:3},showBorder:{type:Boolean,default:!0},borderColor:{type:String,default:"#D2D2D2"},square:{type:Boolean,default:!0},highlight:{type:Boolean,default:!0}},provide(){return{grid:this}},data:()=>({elId:`Uni_${Math.ceil(1e6*Math.random()).toString(36)}`,width:0}),created(){this.children=[]},mounted(){this.$nextTick((()=>{this.init()}))},methods:{init(){setTimeout((()=>{this._getSize((e=>{this.children.forEach(((t,s)=>{t.width=e}))}))}),50)},change(e){this.$emit("change",e)},_getSize(e){v().in(this).select(`#${this.elId}`).boundingClientRect().exec((t=>{this.width=parseInt((t[0].width-1)/this.column)+"px",e(this.width)}))}}},[["render",function(e,t,s,i,o,a){const n=b;return l(),r(n,{class:"uni-grid-wrap"},{default:d((()=>[c(n,{id:o.elId,ref:"uni-grid",class:p(["uni-grid",{"uni-grid--border":s.showBorder}]),style:w({"border-left-color":s.borderColor})},{default:d((()=>[k(e.$slots,"default",{},void 0,!0)])),_:3},8,["id","class","style"])])),_:3})}],["__scopeId","data-v-551d9659"]]);const G=s.database();const P=S({data(){return{gridList:[{label:"背诵时间",value:"0秒"},{label:"背诵文章数",value:"0"},{label:"背诵次数",value:"0"},{label:"背诵准确率",value:"0%"}],ucenterList:[[{title:this.$t("mine.signIn"),event:"signIn",icon:"compose"}],[{title:this.$t("mine.feedback"),to:"/uni_modules/uni-feedback/pages/opendb-feedback/opendb-feedback",icon:"help"},{title:this.$t("mine.settings"),to:"/pages/ucenter/settings/settings",icon:"gear"}]],listStyles:{height:"150rpx",width:"150rpx",border:{color:"#eee",width:"1px",style:"solid",radius:"100%"}}}},onLoad(){},onShow(){this.loadReciteStats()},computed:{userInfo:()=>R.userInfo,hasLogin:()=>R.hasLogin,appConfig:()=>C().globalData.config},methods:{toSettings(){a({url:"/pages/ucenter/settings/settings"})},signIn(){this.$refs.signIn.open()},signInByAd(){this.$refs.signIn.showRewardedVideoAd()},ucenterListClick(e){!e.to&&e.event&&this[e.event]()},async checkVersion(){let e=await new Promise(((e,t)=>{t({message:"请在App中使用"})}));console.log(e),e.result.code>0||i({title:e.result.message,icon:"none"})},toUserInfo(){a({url:"/uni_modules/uni-id-pages/pages/userinfo/userinfo"})},tapGrid(e){},async loadReciteStats(){if(this.hasLogin)try{const e=100;let t=1,i=0;const o=[];for(;;){const a=await s.callFunction({name:"recite-record",data:{action:"list",data:{page:t,pageSize:e}}}),n=a&&a.result||{};if(0!==n.code||!n.data)throw new Error(n.msg||"加载背诵统计失败");const l=n.data.list||[];if(i=n.data.total||0,o.push(...l),o.length>=i||0===l.length)break;t++}const a=new Set;let n=0,l=0,r=0;o.forEach((e=>{e&&e.text_id&&a.add(e.text_id);const t=Number(e.duration_seconds||e.duration||e.recite_duration||e.reciteDuration||0);Number.isFinite(t)&&t>0&&(n+=Math.floor(t));const s=Number(e.accuracy);Number.isFinite(s)&&(l+=s,r++)}));const d=r>0?(l/r).toFixed(1):"0";this.gridList=[{label:"背诵时间",value:this.formatDuration(n)},{label:"背诵文章数",value:String(a.size)},{label:"背诵次数",value:String(o.length)},{label:"背诵准确率",value:`${d}%`}]}catch(e){console.error("加载背诵统计失败",e)}else this.gridList=[{label:"总背诵时间",value:"0秒"},{label:"总背诵文章数",value:"0"},{label:"总背诵次数",value:"0"},{label:"总背诵准确率",value:"0%"}]},formatDuration(e){const t=Number(e)||0;if(t<=0)return"0秒";const s=Math.floor(t/3600),i=Math.floor(t%3600/60),o=t%60;return s>0?`${s}小时${i}分`:i>0?`${i}分${o}秒`:`${o}秒`},gotoMarket(){},getScore(){if(!this.userInfo)return i({title:this.$t("mine.checkScore"),icon:"none"});e({mask:!0}),G.collection("uni-id-scores").where('"user_id" == $env.uid').field("score,balance").orderBy("create_date","desc").limit(1).get().then((e=>{console.log(e);const t=e.result.data[0];let s="";s=t?this.$t("mine.currentScore")+t.balance:this.$t("mine.noScore"),i({title:s,icon:"none"})})).finally((()=>{t()}))},async share(){let{result:e}=await G.collection("uni-id-users").where("'_id' == $cloudEnv_uid").field("my_invite_code").get(),t=e.data[0].my_invite_code;if(!t)return i({title:"请检查uni-config-center中uni-id配置，是否已启用 autoSetInviteCode",icon:"none"});console.log({myInviteCode:t}),this.appConfig.about}}},[["render",function(e,t,s,i,o,a){const p=x(n("uni-sign-in"),q),m=x(n("cloud-image"),F),w=x(n("uni-icons"),L),k=b,v=y,C=x(n("uni-grid-item"),O),$=x(n("uni-grid"),U),S=x(n("uni-list-item"),E),R=x(n("uni-list"),A);return l(),r(k,{class:"center"},{default:d((()=>[c(p,{ref:"signIn"},null,512),c(k,{class:"userInfo",onClickCapture:a.toUserInfo},{default:d((()=>[a.hasLogin&&a.userInfo.avatar_file&&a.userInfo.avatar_file.url?(l(),r(m,{key:0,width:"150rpx",height:"150rpx",src:a.userInfo.avatar_file.url},null,8,["src"])):(l(),r(k,{key:1,class:"defaultAvatarUrl"},{default:d((()=>[c(w,{color:"#ffffff",size:"50",type:"person-filled"})])),_:1})),c(k,{class:"logo-title"},{default:d((()=>[a.hasLogin?(l(),r(v,{key:0,class:"uer-name"},{default:d((()=>[u(h(a.userInfo.nickname||a.userInfo.username||a.userInfo.mobile),1)])),_:1})):(l(),r(v,{key:1,class:"uer-name"},{default:d((()=>[u(h(e.$t("mine.notLogged")),1)])),_:1}))])),_:1})])),_:1},8,["onClickCapture"]),c($,{class:"grid",column:4,showBorder:!1,square:!0},{default:d((()=>[(l(!0),g(f,null,_(o.gridList,((e,t)=>(l(),r(C,{class:"item",onClick:e=>a.tapGrid(t),key:t},{default:d((()=>[c(v,{class:"stat-value"},{default:d((()=>[u(h(e.value),1)])),_:2},1024),c(v,{class:"stat-label"},{default:d((()=>[u(h(e.label),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),(l(!0),g(f,null,_(o.ucenterList,((e,t)=>(l(),r(R,{class:"center-list",key:t},{default:d((()=>[(l(!0),g(f,null,_(e,((e,t)=>(l(),r(S,{title:e.title,link:"",rightText:e.rightText,key:t,clickable:!0,to:e.to,onClick:t=>a.ucenterListClick(e),"show-extra-icon":!0,extraIcon:{type:e.icon,color:"#999"}},{footer:d((()=>[e.showBadge?(l(),r(k,{key:0,class:"item-footer"},{default:d((()=>[c(v,{class:"item-footer-text"},{default:d((()=>[u(h(e.rightText),1)])),_:2},1024),c(k,{class:"item-footer-badge"})])),_:2},1024)):I("",!0)])),_:2},1032,["title","rightText","to","onClick","extraIcon"])))),128))])),_:2},1024)))),128))])),_:1})}],["__scopeId","data-v-81cf6d26"]]);export{P as default};
