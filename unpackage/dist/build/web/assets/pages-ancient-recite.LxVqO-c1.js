import{k as t,z as e,A as s,j as i,B as a,x as r,C as o,c as n,w as h,f as d,o as l,a as c,d as u,t as f,m as k,p as m,F as p,e as g,g as w,y as S}from"./index-mx_jV9ub.js";import{_ as b}from"./_plugin-vue_export-helper.BCo6x5W8.js";const R=b({data:()=>({id:"",textData:{},started:!1,recording:!1,duration:0,durationTimer:null,hintCount:0,hintIndex:0,hintCharCount:0,hints:[],recorderManager:null,socketTask:null,asrConfig:null,taskId:"",taskStarted:!1,taskFinished:!1,frameQueue:[],finalSentences:[],partialSentence:"",realtimeText:"",stopping:!1,waitTaskFinishedResolver:null,useWebRecorder:!1,webAudioContext:null,webMediaStream:null,webScriptProcessor:null,h5MediaRecorder:null,h5AudioChunks:[],h5StopPromiseResolver:null}),onLoad(t){this.id=t.id;const e=r();e.globalData&&e.globalData.currentText&&(this.textData=e.globalData.currentText),this.initRecorder()},onUnload(){clearInterval(this.durationTimer),this.cleanupH5PcmRecorder(),this.recording&&(this.useWebRecorder?this.stopWebRecorder():this.recorderManager&&this.recorderManager.stop()),this.closeSocket(),this.destroyWebRecorder()},methods:{initRecorder(){this.useWebRecorder=!0},async startRecite(){if(!this.recording)try{return this.resetRealtimeState(),this.started=!0,this.recording=!0,this.stopping=!1,this.duration=0,this.durationTimer=setInterval((()=>{this.duration++}),1e3),void(await this.startH5PcmRecorder())}catch(e){this.closeSocket(),t({title:e.message||"启动识别失败",icon:"none",duration:3e3}),console.error("启动实时识别失败:",e)}},showHint(){const e=this.textData.paragraphs||[];if(0===e.length)return;if(this.hintIndex>=e.length)return void t({title:"已无更多提示",icon:"none"});const s=e[this.hintIndex];if(this.hintCharCount++,this.hintCharCount>s.length){if(this.hintIndex++,this.hintCharCount=1,this.hintIndex>=e.length)return void this.hintCount++;const t=e[this.hintIndex];this.hints.push(t.slice(0,1)+"...")}else{const t=s.slice(0,this.hintCharCount)+"...";if(this.hints.length>0&&this.hintIndex===this.hints.length-1+(this.hintCharCount>1?0:1)){const e=this.hints.length-1;e>=0&&(this.hints[e]=t,this.hints=[...this.hints])}else this.hints.push(t)}this.hintCount++},stopRecite(){this.stopping=!0,this.recording=!1,clearInterval(this.durationTimer),this.stopH5PcmRecorder()},async handleRecorderStop(){this.stopping&&(e({title:"正在结束识别..."}),await this.finishTask(),s(),this.goResult(this.realtimeText))},async loadAsrConfig(){const t=(await i.callFunction({name:"asr-config"})).result||{};if(0!==t.code||!t.data)throw new Error(t.msg||"获取语音配置失败");this.asrConfig=t.data},openSocket(){return new Promise(((t,e)=>{let s=this.asrConfig.wsUrl,i={Authorization:`${this.asrConfig.tokenType||"bearer"} ${this.asrConfig.temporaryToken}`};if(!window.isSecureContext)return void e(new Error("H5 录音需要 HTTPS 或 localhost 安全上下文"));const r=this.buildDefaultRelayWsUrl(),o=this.asrConfig.relayWsUrl||r;o?(s=o,i={},this.taskId=this.createTaskId(),this.socketTask=a({url:s,header:i,complete:()=>{}}),this.socketTask.onOpen((()=>{this.sendRunTask(),t()})),this.socketTask.onMessage((({data:t})=>{this.handleSocketMessage(t)})),this.socketTask.onError((t=>{e(new Error("H5 WebSocket 连接失败，请检查临时Token是否有效，以及当前浏览器是否允许在握手中携带鉴权头"))})),this.socketTask.onClose((()=>{this.socketTask=null}))):e(new Error("H5 需要配置 relayWsUrl，或确保当前站点可用 /asr-relay"))}))},sendRunTask(){if(!this.socketTask)return;const t={header:{action:"run-task",task_id:this.taskId,streaming:"duplex"},payload:{task_group:"audio",task:"asr",function:"recognition",model:this.asrConfig.model||"paraformer-realtime-v2",parameters:{format:this.asrConfig.format||"pcm",sample_rate:this.asrConfig.sampleRate||16e3,language_hints:this.asrConfig.languageHints||["zh"],punctuation_prediction_enabled:!1!==this.asrConfig.punctuationPredictionEnabled,inverse_text_normalization_enabled:!1!==this.asrConfig.inverseTextNormalizationEnabled},input:{}}};this.socketTask.send({data:JSON.stringify(t)})},sendAudioFrame(t){t&&this.socketTask&&(this.taskStarted?this.socketTask.send({data:t}):this.frameQueue.push(t))},flushFrameQueue(){if(this.socketTask&&this.taskStarted&&0!==this.frameQueue.length)for(;this.frameQueue.length>0;){const t=this.frameQueue.shift();this.socketTask.send({data:t})}},handleSocketMessage(t){const e=this.decodeSocketData(t);if(!e)return;let s=e;try{s=JSON.parse(e)}catch(r){return}const i=s.header||{},a=i.event;return"task-started"===a?(this.taskStarted=!0,void this.flushFrameQueue()):"result-generated"!==a?"task-finished"===a?(this.taskFinished=!0,this.waitTaskFinishedResolver&&(this.waitTaskFinishedResolver(),this.waitTaskFinishedResolver=null),void this.closeSocket()):void("task-failed"===a&&(console.error("任务失败:",i.error_message||"未知错误"),this.waitTaskFinishedResolver&&(this.waitTaskFinishedResolver(),this.waitTaskFinishedResolver=null),this.closeSocket())):void this.handleRecognizedSentence(s.payload&&s.payload.output&&s.payload.output.sentence)},decodeSocketData(t){if("string"==typeof t)return t;if(!(t instanceof ArrayBuffer))return"";if("undefined"!=typeof TextDecoder)return new TextDecoder("utf-8").decode(t);const e=new Uint8Array(t);let s="";for(let i=0;i<e.length;i++)s+=String.fromCharCode(e[i]);return decodeURIComponent(escape(s))},handleRecognizedSentence(t){if(!t||t.heartbeat)return;const e=t.text||"";e&&(t.sentence_end?(this.finalSentences.push(e),this.partialSentence=""):this.partialSentence=e,this.realtimeText=`${this.finalSentences.join("")}${this.partialSentence}`)},finishTask(){return new Promise((t=>{if(!this.socketTask)return void t();this.taskStarted&&!this.taskFinished&&this.socketTask.send({data:JSON.stringify({header:{action:"finish-task",task_id:this.taskId,streaming:"duplex"},payload:{input:{}}})});const e=setTimeout((()=>{this.closeSocket(),t()}),5e3);this.waitTaskFinishedResolver=()=>{clearTimeout(e),t()}}))},closeSocket(){if(this.socketTask){try{this.socketTask.close({})}catch(t){console.error("关闭 socket 失败:",t)}this.socketTask=null}},resetRealtimeState(){this.taskId="",this.taskStarted=!1,this.taskFinished=!1,this.frameQueue=[],this.finalSentences=[],this.partialSentence="",this.realtimeText="",this.waitTaskFinishedResolver=null},createTaskId:()=>`${Date.now()}-${Math.random().toString(16).slice(2,10)}`,buildDefaultRelayWsUrl(){if(!window.location||!window.location.host)return"";return`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/asr-relay`},async startWebRecorder(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("当前浏览器不支持录音");const t=this.asrConfig.sampleRate||16e3;this.webMediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.webAudioContext=new(window.AudioContext||window.webkitAudioContext);const e=this.webAudioContext.createMediaStreamSource(this.webMediaStream);this.webScriptProcessor=this.webAudioContext.createScriptProcessor(4096,1,1),this.webScriptProcessor.onaudioprocess=e=>{if(!this.recording||!this.socketTask)return;const s=e.inputBuffer.getChannelData(0),i=this.convertFloat32To16kPcm(s,this.webAudioContext.sampleRate,t);i&&i.byteLength>0&&this.sendAudioFrame(i)},e.connect(this.webScriptProcessor),this.webScriptProcessor.connect(this.webAudioContext.destination)},async startH5PcmRecorder(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("当前浏览器不支持录音");if("undefined"==typeof MediaRecorder)throw new Error("当前浏览器不支持 MediaRecorder");this.h5AudioChunks=[],this.webMediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.h5MediaRecorder=new MediaRecorder(this.webMediaStream,{mimeType:"audio/webm"}),this.h5MediaRecorder.ondataavailable=t=>{t.data&&t.data.size>0&&this.h5AudioChunks.push(t.data)},this.h5MediaRecorder.onstop=async()=>{if(this.stopping)try{e({title:"语音识别中..."});const t=new Blob(this.h5AudioChunks,{type:"audio/webm"}),a=await this.blobToBase64(t),r=(await i.callFunction({name:"asr-file-recognize",data:{audioBase64:a,format:"webm"}})).result||{};if(0!==r.code)throw new Error(r.msg||"识别失败");this.realtimeText=r.data&&r.data.text||"",this.goResult(this.realtimeText)}catch(a){t({title:a.message||"识别失败",icon:"none"}),console.error("H5 文件识别失败:",a)}finally{s(),this.cleanupH5PcmRecorder(),this.h5StopPromiseResolver&&(this.h5StopPromiseResolver(),this.h5StopPromiseResolver=null)}},this.h5MediaRecorder.start()},async stopH5PcmRecorder(){this.h5MediaRecorder&&"inactive"!==this.h5MediaRecorder.state?await new Promise((t=>{this.h5StopPromiseResolver=t,this.h5MediaRecorder.stop()})):this.cleanupH5PcmRecorder()},cleanupH5PcmRecorder(){this.webMediaStream&&this.webMediaStream.getTracks().forEach((t=>t.stop())),this.webMediaStream=null,this.h5MediaRecorder=null,this.h5AudioChunks=[],this.h5StopPromiseResolver=null},blobToBase64:t=>new Promise(((e,s)=>{const i=new FileReader;i.onload=()=>{const t=i.result||"",s=String(t).split(",")[1]||"";e(s)},i.onerror=s,i.readAsDataURL(t)})),stopWebRecorder(){this.webScriptProcessor&&(this.webScriptProcessor.disconnect(),this.webScriptProcessor.onaudioprocess=null),this.webMediaStream&&this.webMediaStream.getTracks().forEach((t=>t.stop())),this.webAudioContext&&this.webAudioContext.close(),this.webScriptProcessor=null,this.webMediaStream=null,this.webAudioContext=null},destroyWebRecorder(){this.stopWebRecorder()},convertFloat32To16kPcm(t,e,s){if(!t||0===t.length)return null;const i=e/s,a=Math.max(1,Math.floor(t.length/i)),r=new Int16Array(a);let o=0,n=0;for(;o<a;){const e=Math.floor((o+1)*i);let s=0,a=0;for(let i=n;i<e&&i<t.length;i++)s+=t[i],a++;const h=a>0?s/a:0,d=Math.max(-1,Math.min(1,h));r[o]=d<0?32768*d:32767*d,o++,n=e}return r.buffer},goResult(t){r().globalData=r().globalData||{},r().globalData.reciteResult={textData:this.textData,recognizedText:t,hintCount:this.hintCount},o({url:`/pages/ancient/result?id=${this.id}`})},formatTime(t){const e=Math.floor(t/60),s=t%60;return`${String(e).padStart(2,"0")}:${String(s).padStart(2,"0")}`}}},[["render",function(t,e,s,i,a,r){const o=w,b=d,R=S;return l(),n(b,{class:"container"},{default:h((()=>[c(b,{class:"title-bar"},{default:h((()=>[c(o,{class:"title"},{default:h((()=>[u(f(a.textData.title),1)])),_:1}),c(o,{class:"meta"},{default:h((()=>[u(f(a.textData.dynasty)+" · "+f(a.textData.author),1)])),_:1})])),_:1}),a.hints.length>0?(l(),n(b,{key:0,class:"hint-area"},{default:h((()=>[c(b,{class:"hint-label"},{default:h((()=>[u("提示内容：")])),_:1}),c(b,{class:"hint-content"},{default:h((()=>[(l(!0),k(p,null,m(a.hints,((t,e)=>(l(),n(o,{key:e,class:"hint-text"},{default:h((()=>[u(f(t),1)])),_:2},1024)))),128))])),_:1})])),_:1})):g("",!0),c(b,{class:"status-area"},{default:h((()=>[a.recording?(l(),n(b,{key:0,class:"recording-indicator"},{default:h((()=>[c(o,{class:"recording-dot"},{default:h((()=>[u("●")])),_:1}),c(o,{class:"recording-text"},{default:h((()=>[u("录音中... "+f(r.formatTime(a.duration)),1)])),_:1})])),_:1})):a.started?(l(),n(b,{key:2,class:"status-text"},{default:h((()=>[c(o,null,{default:h((()=>[u("正在处理录音...")])),_:1})])),_:1})):(l(),n(b,{key:1,class:"status-text"},{default:h((()=>[c(o,null,{default:h((()=>[u("准备好后点击开始背诵")])),_:1})])),_:1}))])),_:1}),a.started?(l(),n(b,{key:1,class:"recognized-area"},{default:h((()=>[c(b,{class:"recognized-label"},{default:h((()=>[u("实时识别：")])),_:1}),c(o,{class:"recognized-text"},{default:h((()=>[u(f(a.realtimeText||"等待识别结果..."),1)])),_:1})])),_:1})):g("",!0),c(b,{class:"action-area"},{default:h((()=>[a.started?g("",!0):(l(),n(R,{key:0,type:"primary",class:"btn",onClick:r.startRecite},{default:h((()=>[u("开始背诵")])),_:1},8,["onClick"])),a.recording?(l(),n(R,{key:1,type:"warn",class:"btn",onClick:r.stopRecite},{default:h((()=>[u(" 背诵结束 ")])),_:1},8,["onClick"])):g("",!0)])),_:1})])),_:1})}],["__scopeId","data-v-9361ba22"]]);export{R as default};
