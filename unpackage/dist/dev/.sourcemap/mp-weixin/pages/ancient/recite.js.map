{"version":3,"file":"recite.js","sources":["pages/ancient/recite.vue","pages/ancient/recite.vue?type=page"],"sourcesContent":["<template>\r\n  <view class=\"container\">\r\n    <view class=\"title-bar\">\r\n      <text class=\"title\">{{ textData.title }}</text>\r\n      <text class=\"meta\">{{ textData.dynasty }} · {{ textData.author }}</text>\r\n    </view>\r\n\r\n    <!-- 提示区域 -->\r\n    <view class=\"hint-area\" v-if=\"hints.length > 0\">\r\n      <view class=\"hint-label\">提示内容：</view>\r\n      <view class=\"hint-content\">\r\n        <text v-for=\"(h, idx) in hints\" :key=\"idx\" class=\"hint-text\">\r\n          {{ h }}\r\n        </text>\r\n      </view>\r\n    </view>\r\n\r\n    <!-- 录音状态 -->\r\n    <view class=\"status-area\">\r\n      <view v-if=\"recording\" class=\"recording-indicator\">\r\n        <text class=\"recording-dot\">●</text>\r\n        <text class=\"recording-text\">录音中... {{ formatTime(duration) }}</text>\r\n      </view>\r\n      <view v-else-if=\"!started\" class=\"status-text\">\r\n        <text>准备好后点击开始背诵</text>\r\n      </view>\r\n      <view v-else class=\"status-text\">\r\n        <text>正在处理录音...</text>\r\n      </view>\r\n    </view>\r\n\r\n    <!-- 操作按钮 -->\r\n    <view class=\"action-area\">\r\n      <button\r\n        v-if=\"!started\"\r\n        type=\"primary\"\r\n        class=\"btn\"\r\n        @click=\"startRecite\"\r\n      >开始背诵</button>\r\n\r\n      <template v-if=\"recording\">\r\n        <button class=\"btn btn-hint\" @click=\"showHint\">\r\n          提醒我（已用 {{ hintCount }} 次）\r\n        </button>\r\n        <button type=\"warn\" class=\"btn\" @click=\"stopRecite\">\r\n          背诵结束\r\n        </button>\r\n      </template>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  data() {\r\n    return {\r\n      id: '',\r\n      textData: {},\r\n      started: false,\r\n      recording: false,\r\n      duration: 0,\r\n      durationTimer: null,\r\n      hintCount: 0,\r\n      hintIndex: 0,\r\n      hintCharCount: 0,\r\n      hints: [],\r\n      recorderManager: null\r\n    }\r\n  },\r\n  onLoad(options) {\r\n    this.id = options.id\r\n    const app = getApp()\r\n    if (app.globalData && app.globalData.currentText) {\r\n      this.textData = app.globalData.currentText\r\n    }\r\n    this.initRecorder()\r\n  },\r\n  onUnload() {\r\n    clearInterval(this.durationTimer)\r\n    if (this.recording && this.recorderManager) {\r\n      this.recorderManager.stop()\r\n    }\r\n  },\r\n  methods: {\r\n    initRecorder() {\r\n      this.recorderManager = uni.getRecorderManager()\r\n      this.recorderManager.onStop((res) => {\r\n        this.recording = false\r\n        clearInterval(this.durationTimer)\r\n        this.processRecording(res.tempFilePath)\r\n      })\r\n      this.recorderManager.onError((err) => {\r\n        this.recording = false\r\n        clearInterval(this.durationTimer)\r\n        uni.showToast({ title: '录音失败', icon: 'none' })\r\n        console.error('录音错误:', err)\r\n      })\r\n    },\r\n    startRecite() {\r\n      this.started = true\r\n      this.recording = true\r\n      this.duration = 0\r\n      this.durationTimer = setInterval(() => {\r\n        this.duration++\r\n      }, 1000)\r\n      this.recorderManager.start({\r\n        format: 'mp3',\r\n        sampleRate: 16000,\r\n        numberOfChannels: 1\r\n      })\r\n    },\r\n    showHint() {\r\n      const paragraphs = this.textData.paragraphs || []\r\n      if (paragraphs.length === 0) return\r\n\r\n      if (this.hintIndex >= paragraphs.length) {\r\n        uni.showToast({ title: '已无更多提示', icon: 'none' })\r\n        return\r\n      }\r\n\r\n      const currentSentence = paragraphs[this.hintIndex]\r\n      this.hintCharCount++\r\n\r\n      if (this.hintCharCount > currentSentence.length) {\r\n        this.hintIndex++\r\n        this.hintCharCount = 1\r\n        if (this.hintIndex >= paragraphs.length) {\r\n          this.hintCount++\r\n          return\r\n        }\r\n        const nextSentence = paragraphs[this.hintIndex]\r\n        this.hints.push(nextSentence.slice(0, 1) + '...')\r\n      } else {\r\n        const hintText = currentSentence.slice(0, this.hintCharCount) + '...'\r\n        if (this.hints.length > 0 && this.hintIndex === this.hints.length - 1 + (this.hintCharCount > 1 ? 0 : 1)) {\r\n          // 更新当前句的提示\r\n          const lastIdx = this.hints.length - 1\r\n          if (lastIdx >= 0) {\r\n            this.hints[lastIdx] = hintText\r\n            this.hints = [...this.hints]\r\n          }\r\n        } else {\r\n          this.hints.push(hintText)\r\n        }\r\n      }\r\n      this.hintCount++\r\n    },\r\n    stopRecite() {\r\n      this.recorderManager.stop()\r\n    },\r\n    processRecording(filePath) {\r\n      uni.showLoading({ title: '语音识别中...' })\r\n      // #ifdef APP-PLUS\r\n      this.appSpeechRecognize(filePath)\r\n      // #endif\r\n      // #ifdef MP-WEIXIN\r\n      this.wxSpeechRecognize(filePath)\r\n      // #endif\r\n    },\r\n    appSpeechRecognize(filePath) {\r\n      if (plus.speech) {\r\n        plus.speech.startRecognize({\r\n          engine: 'iFly',\r\n          lang: 'zh-cn',\r\n          'userInterface': false,\r\n          nbest: 1\r\n        }, (text) => {\r\n          uni.hideLoading()\r\n          this.goResult(text)\r\n        }, (err) => {\r\n          uni.hideLoading()\r\n          uni.showToast({ title: '识别失败', icon: 'none' })\r\n          console.error('语音识别错误:', err)\r\n        })\r\n      }\r\n    },\r\n    wxSpeechRecognize(filePath) {\r\n      const plugin = requirePlugin('WechatSI')\r\n      plugin.manager = plugin.getRecordRecognitionManager()\r\n      // 微信同声传译：直接用文件识别\r\n      uni.uploadFile({\r\n        url: '', // 需配置实际地址或使用插件\r\n        filePath,\r\n        name: 'file',\r\n        success: () => {\r\n          uni.hideLoading()\r\n          // fallback: 暂用空文本\r\n          this.goResult('')\r\n        },\r\n        fail: () => {\r\n          uni.hideLoading()\r\n          this.goResult('')\r\n        }\r\n      })\r\n    },\r\n    goResult(recognizedText) {\r\n      getApp().globalData = getApp().globalData || {}\r\n      getApp().globalData.reciteResult = {\r\n        textData: this.textData,\r\n        recognizedText,\r\n        hintCount: this.hintCount\r\n      }\r\n      uni.redirectTo({\r\n        url: `/pages/ancient/result?id=${this.id}`\r\n      })\r\n    },\r\n    formatTime(seconds) {\r\n      const m = Math.floor(seconds / 60)\r\n      const s = seconds % 60\r\n      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.container {\r\n  padding: 40rpx;\r\n  min-height: 100vh;\r\n  background: #f5f5f5;\r\n}\r\n.title-bar {\r\n  text-align: center;\r\n  margin-bottom: 60rpx;\r\n}\r\n.title {\r\n  display: block;\r\n  font-size: 44rpx;\r\n  font-weight: bold;\r\n  color: #333;\r\n  margin-bottom: 12rpx;\r\n}\r\n.meta {\r\n  font-size: 28rpx;\r\n  color: #888;\r\n}\r\n.hint-area {\r\n  background: #fffbe6;\r\n  border-radius: 12rpx;\r\n  padding: 24rpx;\r\n  margin-bottom: 40rpx;\r\n  border-left: 6rpx solid #faad14;\r\n}\r\n.hint-label {\r\n  font-size: 26rpx;\r\n  color: #999;\r\n  margin-bottom: 12rpx;\r\n}\r\n.hint-text {\r\n  display: block;\r\n  font-size: 32rpx;\r\n  color: #333;\r\n  line-height: 1.8;\r\n}\r\n.status-area {\r\n  text-align: center;\r\n  margin-bottom: 60rpx;\r\n  padding: 40rpx 0;\r\n}\r\n.recording-indicator {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n.recording-dot {\r\n  color: #e74c3c;\r\n  font-size: 40rpx;\r\n  margin-right: 12rpx;\r\n  animation: blink 1s infinite;\r\n}\r\n@keyframes blink {\r\n  0%, 100% { opacity: 1; }\r\n  50% { opacity: 0.3; }\r\n}\r\n.recording-text {\r\n  font-size: 32rpx;\r\n  color: #333;\r\n}\r\n.status-text {\r\n  font-size: 30rpx;\r\n  color: #999;\r\n}\r\n.action-area {\r\n  padding: 0 20rpx;\r\n}\r\n.btn {\r\n  width: 100%;\r\n  margin-bottom: 24rpx;\r\n  border-radius: 12rpx;\r\n}\r\n.btn-hint {\r\n  background: #fff;\r\n  color: #333;\r\n  border: 1rpx solid #ddd;\r\n}\r\n</style>\r\n","import MiniProgramPage from '/Users/chensm/Desktop/my-source/github.com/simwy/AI-Recite-Ancient-Mobile/pages/ancient/recite.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni"],"mappings":";;AAqDA,MAAK,YAAU;AAAA,EACb,OAAO;AACL,WAAO;AAAA,MACL,IAAI;AAAA,MACJ,UAAU,CAAE;AAAA,MACZ,SAAS;AAAA,MACT,WAAW;AAAA,MACX,UAAU;AAAA,MACV,eAAe;AAAA,MACf,WAAW;AAAA,MACX,WAAW;AAAA,MACX,eAAe;AAAA,MACf,OAAO,CAAE;AAAA,MACT,iBAAiB;AAAA,IACnB;AAAA,EACD;AAAA,EACD,OAAO,SAAS;AACd,SAAK,KAAK,QAAQ;AAClB,UAAM,MAAM,OAAO;AACnB,QAAI,IAAI,cAAc,IAAI,WAAW,aAAa;AAChD,WAAK,WAAW,IAAI,WAAW;AAAA,IACjC;AACA,SAAK,aAAa;AAAA,EACnB;AAAA,EACD,WAAW;AACT,kBAAc,KAAK,aAAa;AAChC,QAAI,KAAK,aAAa,KAAK,iBAAiB;AAC1C,WAAK,gBAAgB,KAAK;AAAA,IAC5B;AAAA,EACD;AAAA,EACD,SAAS;AAAA,IACP,eAAe;AACb,WAAK,kBAAkBA,cAAG,MAAC,mBAAmB;AAC9C,WAAK,gBAAgB,OAAO,CAAC,QAAQ;AACnC,aAAK,YAAY;AACjB,sBAAc,KAAK,aAAa;AAChC,aAAK,iBAAiB,IAAI,YAAY;AAAA,OACvC;AACD,WAAK,gBAAgB,QAAQ,CAAC,QAAQ;AACpC,aAAK,YAAY;AACjB,sBAAc,KAAK,aAAa;AAChCA,sBAAG,MAAC,UAAU,EAAE,OAAO,QAAQ,MAAM,QAAQ;AAC7CA,sBAAAA,uDAAc,SAAS,GAAG;AAAA,OAC3B;AAAA,IACF;AAAA,IACD,cAAc;AACZ,WAAK,UAAU;AACf,WAAK,YAAY;AACjB,WAAK,WAAW;AAChB,WAAK,gBAAgB,YAAY,MAAM;AACrC,aAAK;AAAA,MACN,GAAE,GAAI;AACP,WAAK,gBAAgB,MAAM;AAAA,QACzB,QAAQ;AAAA,QACR,YAAY;AAAA,QACZ,kBAAkB;AAAA,OACnB;AAAA,IACF;AAAA,IACD,WAAW;AACT,YAAM,aAAa,KAAK,SAAS,cAAc,CAAC;AAChD,UAAI,WAAW,WAAW;AAAG;AAE7B,UAAI,KAAK,aAAa,WAAW,QAAQ;AACvCA,sBAAG,MAAC,UAAU,EAAE,OAAO,UAAU,MAAM,QAAQ;AAC/C;AAAA,MACF;AAEA,YAAM,kBAAkB,WAAW,KAAK,SAAS;AACjD,WAAK;AAEL,UAAI,KAAK,gBAAgB,gBAAgB,QAAQ;AAC/C,aAAK;AACL,aAAK,gBAAgB;AACrB,YAAI,KAAK,aAAa,WAAW,QAAQ;AACvC,eAAK;AACL;AAAA,QACF;AACA,cAAM,eAAe,WAAW,KAAK,SAAS;AAC9C,aAAK,MAAM,KAAK,aAAa,MAAM,GAAG,CAAC,IAAI,KAAK;AAAA,aAC3C;AACL,cAAM,WAAW,gBAAgB,MAAM,GAAG,KAAK,aAAa,IAAI;AAChE,YAAI,KAAK,MAAM,SAAS,KAAK,KAAK,cAAc,KAAK,MAAM,SAAS,KAAK,KAAK,gBAAgB,IAAI,IAAI,IAAI;AAExG,gBAAM,UAAU,KAAK,MAAM,SAAS;AACpC,cAAI,WAAW,GAAG;AAChB,iBAAK,MAAM,OAAO,IAAI;AACtB,iBAAK,QAAQ,CAAC,GAAG,KAAK,KAAK;AAAA,UAC7B;AAAA,eACK;AACL,eAAK,MAAM,KAAK,QAAQ;AAAA,QAC1B;AAAA,MACF;AACA,WAAK;AAAA,IACN;AAAA,IACD,aAAa;AACX,WAAK,gBAAgB,KAAK;AAAA,IAC3B;AAAA,IACD,iBAAiB,UAAU;AACzBA,oBAAAA,MAAI,YAAY,EAAE,OAAO,YAAY;AAKrC,WAAK,kBAAkB,QAAQ;AAAA,IAEhC;AAAA,IACD,mBAAmB,UAAU;AAC3B,UAAI,KAAK,QAAQ;AACf,aAAK,OAAO,eAAe;AAAA,UACzB,QAAQ;AAAA,UACR,MAAM;AAAA,UACN,iBAAiB;AAAA,UACjB,OAAO;AAAA,QACR,GAAE,CAAC,SAAS;AACXA,wBAAAA,MAAI,YAAY;AAChB,eAAK,SAAS,IAAI;AAAA,QACnB,GAAE,CAAC,QAAQ;AACVA,wBAAAA,MAAI,YAAY;AAChBA,wBAAG,MAAC,UAAU,EAAE,OAAO,QAAQ,MAAM,QAAQ;AAC7CA,wBAAAA,MAAA,MAAA,SAAA,mCAAc,WAAW,GAAG;AAAA,SAC7B;AAAA,MACH;AAAA,IACD;AAAA,IACD,kBAAkB,UAAU;AAC1B,YAAM,SAAS,cAAc,UAAU;AACvC,aAAO,UAAU,OAAO,4BAA4B;AAEpDA,oBAAAA,MAAI,WAAW;AAAA,QACb,KAAK;AAAA;AAAA,QACL;AAAA,QACA,MAAM;AAAA,QACN,SAAS,MAAM;AACbA,wBAAAA,MAAI,YAAY;AAEhB,eAAK,SAAS,EAAE;AAAA,QACjB;AAAA,QACD,MAAM,MAAM;AACVA,wBAAAA,MAAI,YAAY;AAChB,eAAK,SAAS,EAAE;AAAA,QAClB;AAAA,OACD;AAAA,IACF;AAAA,IACD,SAAS,gBAAgB;AACvB,aAAQ,EAAC,aAAa,OAAQ,EAAC,cAAc,CAAC;AAC9C,aAAQ,EAAC,WAAW,eAAe;AAAA,QACjC,UAAU,KAAK;AAAA,QACf;AAAA,QACA,WAAW,KAAK;AAAA,MAClB;AACAA,oBAAAA,MAAI,WAAW;AAAA,QACb,KAAK,4BAA4B,KAAK,EAAE;AAAA,OACzC;AAAA,IACF;AAAA,IACD,WAAW,SAAS;AAClB,YAAM,IAAI,KAAK,MAAM,UAAU,EAAE;AACjC,YAAM,IAAI,UAAU;AACpB,aAAO,GAAG,OAAO,CAAC,EAAE,SAAS,GAAG,GAAG,CAAC,IAAI,OAAO,CAAC,EAAE,SAAS,GAAG,GAAG,CAAC;AAAA,IACpE;AAAA,EACF;AACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnNA,GAAG,WAAW,eAAe;"}