{"version":3,"file":"ad.js","sources":["uni_modules/uni-sign-in/utils/ad.js"],"sourcesContent":["// ad.js\nconst ADType = {\n  RewardedVideo: \"RewardedVideo\",\n  FullScreenVideo: \"FullScreenVideo\"\n}\n\nclass AdHelper {\n\n  constructor() {\n    this._ads = {}\n  }\n\n  load(options, onload, onerror) {\n    let ops = this._fixOldOptions(options)\n    let {\n      adpid\n    } = ops\n\n    if (!adpid || this.isBusy(adpid)) {\n      return\n    }\n\n    this.get(ops).load(onload, onerror)\n  }\n\n  show(options, onsuccess, onfail) {\n    let ops = this._fixOldOptions(options)\n    let {\n      adpid\n    } = ops\n\n    if (!adpid) {\n      return\n    }\n\n    uni.showLoading({\n      mask: true\n    })\n\n    var ad = this.get(ops)\n\n    ad.load(() => {\n      uni.hideLoading()\n      ad.show((e) => {\n        onsuccess && onsuccess(e)\n      })\n    }, (err) => {\n      uni.hideLoading()\n      onfail && onfail(err)\n    })\n  }\n\n  isBusy(adpid) {\n    return (this._ads[adpid] && this._ads[adpid].isLoading)\n  }\n\n  get(options) {\n    const {\n      adpid,\n      singleton = true\n    } = options\n    if (singleton === false) {\n      if (this._ads[adpid]) {\n        this._ads[adpid].destroy()\n        delete this._ads[adpid]\n      }\n    }\n    delete options.singleton\n    if (!this._ads[adpid]) {\n      this._ads[adpid] = this._createAdInstance(options)\n    }\n\n    return this._ads[adpid]\n  }\n\n  _createAdInstance(options) {\n    const adType = options.adType || ADType.RewardedVideo\n    delete options.adType\n\n    let ad = null;\n    if (adType === ADType.RewardedVideo) {\n      ad = new RewardedVideo(options)\n    } else if (adType === ADType.FullScreenVideo) {\n      ad = new FullScreenVideo(options)\n    }\n\n    return ad\n  }\n\n  _fixOldOptions(options) {\n    return (typeof options === \"string\") ? {\n      adpid: options\n    } : options\n  }\n}\n\nconst EXPIRED_TIME = 1000 * 60 * 30\nconst ProviderType = {\n  CSJ: 'csj',\n  GDT: 'gdt'\n}\n\nconst RETRY_COUNT = 1\n\nclass AdBase {\n  constructor(adInstance, options = {}) {\n    this._isLoad = false\n    this._isLoading = false\n    this._lastLoadTime = 0\n    this._lastError = null\n    this._retryCount = 0\n\n    this._loadCallback = null\n    this._closeCallback = null\n    this._errorCallback = null\n\n    const ad = this._ad = adInstance\n    ad.onLoad((e) => {\n      this._isLoading = false\n      this._isLoad = true\n      this._lastLoadTime = Date.now()\n\n      this.onLoad()\n    })\n    ad.onClose((e) => {\n      this._isLoad = false\n      this.onClose(e)\n    })\n    ad.onVerify && ad.onVerify((e) => {\n      // e.isValid\n    })\n    ad.onError(({\n      code,\n      message\n    }) => {\n      this._isLoading = false\n      const data = {\n        code: code,\n        errMsg: message\n      }\n\n      if (code === -5008) {\n        this._loadAd()\n        return\n      }\n\n      if (this._retryCount < RETRY_COUNT) {\n        this._retryCount += 1\n        this._loadAd()\n        return\n      }\n\n      this._lastError = data\n      this.onError(data)\n    })\n  }\n\n  get isExpired() {\n    return (this._lastLoadTime !== 0 && (Math.abs(Date.now() - this._lastLoadTime) > EXPIRED_TIME))\n  }\n\n  get isLoading() {\n    return this._isLoading\n  }\n\n  getProvider() {\n    return this._ad.getProvider()\n  }\n\n  load(onload, onerror) {\n    this._loadCallback = onload\n    this._errorCallback = onerror\n\n    if (this._isLoading) {\n      return\n    }\n\n    if (this._isLoad) {\n      this.onLoad()\n      return\n    }\n\n    this._retryCount = 0\n\n    this._loadAd()\n  }\n\n  show(onclose) {\n    this._closeCallback = onclose\n\n    if (this._isLoading || !this._isLoad) {\n      return\n    }\n\n    if (this._lastError !== null) {\n      this.onError(this._lastError)\n      return\n    }\n\n    const provider = this.getProvider()\n    if (provider === ProviderType.CSJ && this.isExpired) {\n      this._loadAd()\n      return\n    }\n\n    this._ad.show()\n  }\n\n  onLoad(e) {\n    if (this._loadCallback != null) {\n      this._loadCallback()\n    }\n  }\n\n  onClose(e) {\n    if (this._closeCallback != null) {\n      this._closeCallback({\n        isEnded: e.isEnded\n      })\n    }\n  }\n\n  onError(e) {\n    if (this._errorCallback != null) {\n      this._errorCallback(e)\n    }\n  }\n\n  destroy() {\n    this._ad.destroy()\n  }\n\n  _loadAd() {\n    this._isLoad = false\n    this._isLoading = true\n    this._lastError = null\n    this._ad.load()\n  }\n}\n\nclass RewardedVideo extends AdBase {\n  constructor(options = {}) {\n    super(plus.ad.createRewardedVideoAd(options), options)\n  }\n}\n\nclass FullScreenVideo extends AdBase {\n  constructor(options = {}) {\n    super(plus.ad.createFullScreenVideoAd(options), options)\n  }\n}\n\nexport default new AdHelper()"],"names":["uni"],"mappings":"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"}