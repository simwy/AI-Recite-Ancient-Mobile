{"version":3,"file":"diff.js","sources":["common/diff.js"],"sourcesContent":["/**\r\n * 古文逐字对比工具（基于 LCS 最长公共子序列）\r\n */\r\n\r\n// 过滤标点符号，只保留文字\r\nfunction filterPunctuation(text) {\r\n  return text.replace(/[，。、；：？！\"\"''（）《》\\s\\n\\r,.;:?!'\"()\\[\\]{}]/g, '')\r\n}\r\n\r\n/**\r\n * 计算两个字符串的 LCS 表\r\n */\r\nfunction buildLCSTable(a, b) {\r\n  const m = a.length\r\n  const n = b.length\r\n  const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0))\r\n\r\n  for (let i = 1; i <= m; i++) {\r\n    for (let j = 1; j <= n; j++) {\r\n      if (a[i - 1] === b[j - 1]) {\r\n        dp[i][j] = dp[i - 1][j - 1] + 1\r\n      } else {\r\n        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1])\r\n      }\r\n    }\r\n  }\r\n  return dp\r\n}\r\n\r\n/**\r\n * 逐字对比原文和识别文字\r\n * @param {string} original - 原文\r\n * @param {string} recognized - 语音识别文字\r\n * @returns {Array<{char: string, status: 'correct'|'wrong'|'missing'}>}\r\n */\r\nexport function diffChars(original, recognized) {\r\n  const a = filterPunctuation(original)\r\n  const b = filterPunctuation(recognized)\r\n  const dp = buildLCSTable(a, b)\r\n\r\n  const result = []\r\n  let i = a.length\r\n  let j = b.length\r\n\r\n  // 回溯 LCS\r\n  const marks = []\r\n  while (i > 0 && j > 0) {\r\n    if (a[i - 1] === b[j - 1]) {\r\n      marks.unshift({ i: i - 1, j: j - 1, match: true })\r\n      i--\r\n      j--\r\n    } else if (dp[i - 1][j] >= dp[i][j - 1]) {\r\n      i--\r\n    } else {\r\n      j--\r\n    }\r\n  }\r\n\r\n  // 根据匹配结果生成 diff\r\n  let mi = 0\r\n  for (let idx = 0; idx < a.length; idx++) {\r\n    if (mi < marks.length && marks[mi].i === idx) {\r\n      result.push({ char: a[idx], status: 'correct' })\r\n      mi++\r\n    } else {\r\n      result.push({ char: a[idx], status: 'missing' })\r\n    }\r\n  }\r\n\r\n  return result\r\n}\r\n\r\n/**\r\n * 计算正确率\r\n * @param {Array} diffResult - diffChars 返回的结果\r\n * @returns {number} 0-100 的正确率\r\n */\r\nexport function calcAccuracy(diffResult) {\r\n  if (!diffResult || diffResult.length === 0) return 0\r\n  const correct = diffResult.filter(d => d.status === 'correct').length\r\n  return Math.round((correct / diffResult.length) * 100)\r\n}\r\n"],"names":[],"mappings":";AAKA,SAAS,kBAAkB,MAAM;AAC/B,SAAO,KAAK,QAAQ,4CAA4C,EAAE;AACpE;AAKA,SAAS,cAAc,GAAG,GAAG;AAC3B,QAAM,IAAI,EAAE;AACZ,QAAM,IAAI,EAAE;AACZ,QAAM,KAAK,MAAM,KAAK,EAAE,QAAQ,IAAI,EAAC,GAAI,MAAM,IAAI,MAAM,IAAI,CAAC,EAAE,KAAK,CAAC,CAAC;AAEvE,WAAS,IAAI,GAAG,KAAK,GAAG,KAAK;AAC3B,aAAS,IAAI,GAAG,KAAK,GAAG,KAAK;AAC3B,UAAI,EAAE,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,GAAG;AACzB,WAAG,CAAC,EAAE,CAAC,IAAI,GAAG,IAAI,CAAC,EAAE,IAAI,CAAC,IAAI;AAAA,MACtC,OAAa;AACL,WAAG,CAAC,EAAE,CAAC,IAAI,KAAK,IAAI,GAAG,IAAI,CAAC,EAAE,CAAC,GAAG,GAAG,CAAC,EAAE,IAAI,CAAC,CAAC;AAAA,MAC/C;AAAA,IACF;AAAA,EACF;AACD,SAAO;AACT;AAQO,SAAS,UAAU,UAAU,YAAY;AAC9C,QAAM,IAAI,kBAAkB,QAAQ;AACpC,QAAM,IAAI,kBAAkB,UAAU;AACtC,QAAM,KAAK,cAAc,GAAG,CAAC;AAE7B,QAAM,SAAS,CAAE;AACjB,MAAI,IAAI,EAAE;AACV,MAAI,IAAI,EAAE;AAGV,QAAM,QAAQ,CAAE;AAChB,SAAO,IAAI,KAAK,IAAI,GAAG;AACrB,QAAI,EAAE,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,GAAG;AACzB,YAAM,QAAQ,EAAE,GAAG,IAAI,GAAG,GAAG,IAAI,GAAG,OAAO,KAAI,CAAE;AACjD;AACA;AAAA,IACD,WAAU,GAAG,IAAI,CAAC,EAAE,CAAC,KAAK,GAAG,CAAC,EAAE,IAAI,CAAC,GAAG;AACvC;AAAA,IACN,OAAW;AACL;AAAA,IACD;AAAA,EACF;AAGD,MAAI,KAAK;AACT,WAAS,MAAM,GAAG,MAAM,EAAE,QAAQ,OAAO;AACvC,QAAI,KAAK,MAAM,UAAU,MAAM,EAAE,EAAE,MAAM,KAAK;AAC5C,aAAO,KAAK,EAAE,MAAM,EAAE,GAAG,GAAG,QAAQ,WAAW;AAC/C;AAAA,IACN,OAAW;AACL,aAAO,KAAK,EAAE,MAAM,EAAE,GAAG,GAAG,QAAQ,WAAW;AAAA,IAChD;AAAA,EACF;AAED,SAAO;AACT;AAOO,SAAS,aAAa,YAAY;AACvC,MAAI,CAAC,cAAc,WAAW,WAAW;AAAG,WAAO;AACnD,QAAM,UAAU,WAAW,OAAO,OAAK,EAAE,WAAW,SAAS,EAAE;AAC/D,SAAO,KAAK,MAAO,UAAU,WAAW,SAAU,GAAG;AACvD;;;"}