{"version":3,"file":"diff.js","sources":["common/diff.js"],"sourcesContent":["/**\r\n * 古文逐字对比工具（基于 LCS 最长公共子序列）\r\n */\r\nimport { pinyin } from 'pinyin-pro'\r\n\r\nconst PUNCTUATION_REG = /[，。、；：？！“”‘’（）《》〈〉【】「」『』〔〕…—\\s\\n\\r,.;:?!'\"()\\[\\]{}]/\r\nconst pinyinCache = new Map()\r\n\r\nfunction isPunctuation(char) {\r\n  return PUNCTUATION_REG.test(char)\r\n}\r\n\r\n// 过滤标点并保留原始索引，便于最终还原完整显示内容\r\nfunction normalizeForDiff(text) {\r\n  const chars = String(text || '').split('')\r\n  const filtered = []\r\n\r\n  chars.forEach((char, index) => {\r\n    if (!isPunctuation(char)) {\r\n      filtered.push({ char, index })\r\n    }\r\n  })\r\n\r\n  return { chars, filtered }\r\n}\r\n\r\nfunction getCharPinyin(char) {\r\n  if (!char) return ''\r\n  if (pinyinCache.has(char)) return pinyinCache.get(char)\r\n\r\n  const value = pinyin(char, {\r\n    toneType: 'none',\r\n    type: 'array'\r\n  })\r\n  const first = Array.isArray(value) && value.length ? value[0] : ''\r\n  pinyinCache.set(char, first)\r\n  return first\r\n}\r\n\r\nfunction isHomophone(a, b) {\r\n  if (!a || !b) return false\r\n  if (a === b) return true\r\n  const aPy = getCharPinyin(a)\r\n  const bPy = getCharPinyin(b)\r\n  return Boolean(aPy && bPy && aPy === bPy)\r\n}\r\n\r\n/**\r\n * 计算两个字符串的 LCS 表\r\n */\r\nfunction buildLCSTable(a, b) {\r\n  const m = a.length\r\n  const n = b.length\r\n  const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0))\r\n\r\n  for (let i = 1; i <= m; i++) {\r\n    for (let j = 1; j <= n; j++) {\r\n      if (isHomophone(a[i - 1].char, b[j - 1].char)) {\r\n        dp[i][j] = dp[i - 1][j - 1] + 1\r\n      } else {\r\n        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1])\r\n      }\r\n    }\r\n  }\r\n  return dp\r\n}\r\n\r\n/**\r\n * 逐字对比原文和识别文字\r\n * @param {string} original - 原文\r\n * @param {string} recognized - 语音识别文字\r\n * @returns {Array<{char: string, status: 'correct'|'wrong'|'missing'}>}\r\n */\r\nexport function diffChars(original, recognized) {\r\n  const source = normalizeForDiff(original)\r\n  const target = normalizeForDiff(recognized)\r\n  const a = source.filtered\r\n  const b = target.filtered\r\n  const dp = buildLCSTable(a, b)\r\n\r\n  const result = source.chars.map(char => ({\r\n    char,\r\n    status: isPunctuation(char) ? 'punctuation' : 'missing'\r\n  }))\r\n  let i = a.length\r\n  let j = b.length\r\n\r\n  // 回溯 LCS\r\n  const matchedOriginalIndexes = new Set()\r\n  while (i > 0 && j > 0) {\r\n    if (isHomophone(a[i - 1].char, b[j - 1].char)) {\r\n      matchedOriginalIndexes.add(a[i - 1].index)\r\n      i--\r\n      j--\r\n    } else if (dp[i - 1][j] >= dp[i][j - 1]) {\r\n      i--\r\n    } else {\r\n      j--\r\n    }\r\n  }\r\n\r\n  source.chars.forEach((char, index) => {\r\n    if (!isPunctuation(char) && matchedOriginalIndexes.has(index)) {\r\n      result[index] = { char, status: 'correct' }\r\n    }\r\n  })\r\n\r\n  return result\r\n}\r\n\r\n/**\r\n * 计算正确率\r\n * @param {Array} diffResult - diffChars 返回的结果\r\n * @returns {number} 0-100 的正确率\r\n */\r\nexport function calcAccuracy(diffResult) {\r\n  if (!diffResult || diffResult.length === 0) return 0\r\n  const compareChars = diffResult.filter(d => d.status !== 'punctuation')\r\n  if (compareChars.length === 0) return 0\r\n  const correct = compareChars.filter(d => d.status === 'correct').length\r\n  return Math.round((correct / compareChars.length) * 100)\r\n}\r\n"],"names":["pinyin"],"mappings":";;AAKA,MAAM,kBAAkB;AACxB,MAAM,cAAc,oBAAI,IAAK;AAE7B,SAAS,cAAc,MAAM;AAC3B,SAAO,gBAAgB,KAAK,IAAI;AAClC;AAGA,SAAS,iBAAiB,MAAM;AAC9B,QAAM,QAAQ,OAAO,QAAQ,EAAE,EAAE,MAAM,EAAE;AACzC,QAAM,WAAW,CAAE;AAEnB,QAAM,QAAQ,CAAC,MAAM,UAAU;AAC7B,QAAI,CAAC,cAAc,IAAI,GAAG;AACxB,eAAS,KAAK,EAAE,MAAM,MAAK,CAAE;AAAA,IAC9B;AAAA,EACL,CAAG;AAED,SAAO,EAAE,OAAO,SAAU;AAC5B;AAEA,SAAS,cAAc,MAAM;AAC3B,MAAI,CAAC;AAAM,WAAO;AAClB,MAAI,YAAY,IAAI,IAAI;AAAG,WAAO,YAAY,IAAI,IAAI;AAEtD,QAAM,QAAQA,cAAM,OAAC,MAAM;AAAA,IACzB,UAAU;AAAA,IACV,MAAM;AAAA,EACV,CAAG;AACD,QAAM,QAAQ,MAAM,QAAQ,KAAK,KAAK,MAAM,SAAS,MAAM,CAAC,IAAI;AAChE,cAAY,IAAI,MAAM,KAAK;AAC3B,SAAO;AACT;AAEA,SAAS,YAAY,GAAG,GAAG;AACzB,MAAI,CAAC,KAAK,CAAC;AAAG,WAAO;AACrB,MAAI,MAAM;AAAG,WAAO;AACpB,QAAM,MAAM,cAAc,CAAC;AAC3B,QAAM,MAAM,cAAc,CAAC;AAC3B,SAAO,QAAQ,OAAO,OAAO,QAAQ,GAAG;AAC1C;AAKA,SAAS,cAAc,GAAG,GAAG;AAC3B,QAAM,IAAI,EAAE;AACZ,QAAM,IAAI,EAAE;AACZ,QAAM,KAAK,MAAM,KAAK,EAAE,QAAQ,IAAI,EAAC,GAAI,MAAM,IAAI,MAAM,IAAI,CAAC,EAAE,KAAK,CAAC,CAAC;AAEvE,WAAS,IAAI,GAAG,KAAK,GAAG,KAAK;AAC3B,aAAS,IAAI,GAAG,KAAK,GAAG,KAAK;AAC3B,UAAI,YAAY,EAAE,IAAI,CAAC,EAAE,MAAM,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAC7C,WAAG,CAAC,EAAE,CAAC,IAAI,GAAG,IAAI,CAAC,EAAE,IAAI,CAAC,IAAI;AAAA,MACtC,OAAa;AACL,WAAG,CAAC,EAAE,CAAC,IAAI,KAAK,IAAI,GAAG,IAAI,CAAC,EAAE,CAAC,GAAG,GAAG,CAAC,EAAE,IAAI,CAAC,CAAC;AAAA,MAC/C;AAAA,IACF;AAAA,EACF;AACD,SAAO;AACT;AAQO,SAAS,UAAU,UAAU,YAAY;AAC9C,QAAM,SAAS,iBAAiB,QAAQ;AACxC,QAAM,SAAS,iBAAiB,UAAU;AAC1C,QAAM,IAAI,OAAO;AACjB,QAAM,IAAI,OAAO;AACjB,QAAM,KAAK,cAAc,GAAG,CAAC;AAE7B,QAAM,SAAS,OAAO,MAAM,IAAI,WAAS;AAAA,IACvC;AAAA,IACA,QAAQ,cAAc,IAAI,IAAI,gBAAgB;AAAA,EAClD,EAAI;AACF,MAAI,IAAI,EAAE;AACV,MAAI,IAAI,EAAE;AAGV,QAAM,yBAAyB,oBAAI,IAAK;AACxC,SAAO,IAAI,KAAK,IAAI,GAAG;AACrB,QAAI,YAAY,EAAE,IAAI,CAAC,EAAE,MAAM,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAC7C,6BAAuB,IAAI,EAAE,IAAI,CAAC,EAAE,KAAK;AACzC;AACA;AAAA,IACD,WAAU,GAAG,IAAI,CAAC,EAAE,CAAC,KAAK,GAAG,CAAC,EAAE,IAAI,CAAC,GAAG;AACvC;AAAA,IACN,OAAW;AACL;AAAA,IACD;AAAA,EACF;AAED,SAAO,MAAM,QAAQ,CAAC,MAAM,UAAU;AACpC,QAAI,CAAC,cAAc,IAAI,KAAK,uBAAuB,IAAI,KAAK,GAAG;AAC7D,aAAO,KAAK,IAAI,EAAE,MAAM,QAAQ,UAAW;AAAA,IAC5C;AAAA,EACL,CAAG;AAED,SAAO;AACT;AAOO,SAAS,aAAa,YAAY;AACvC,MAAI,CAAC,cAAc,WAAW,WAAW;AAAG,WAAO;AACnD,QAAM,eAAe,WAAW,OAAO,OAAK,EAAE,WAAW,aAAa;AACtE,MAAI,aAAa,WAAW;AAAG,WAAO;AACtC,QAAM,UAAU,aAAa,OAAO,OAAK,EAAE,WAAW,SAAS,EAAE;AACjE,SAAO,KAAK,MAAO,UAAU,aAAa,SAAU,GAAG;AACzD;;;"}