"use strict";const e=require("@dcloudio/uni-h5"),t=require("@dcloudio/uni-cloud"),i=require("../entry-server.js"),n=require("vue"),o=[{path:"pages/ancient/list",style:{navigationBarTitleText:"文言文背诵 AI小助手"}},{path:"pages/ancient/history",style:{navigationBarTitleText:"背诵历史"}},{path:"pages/ancient/detail",style:{navigationBarTitleText:"古文详情"}},{path:"pages/ancient/recite",style:{navigationBarTitleText:"背诵模式"},needLogin:!0},{path:"pages/ancient/result",style:{navigationBarTitleText:"背诵结果"}},{path:"pages/ucenter/ucenter",style:{navigationStyle:"custom"}},{path:"pages/uni-agree/uni-agree",style:{navigationStyle:"custom","app-plus":{popGesture:"none"}}},{path:"pages/ucenter/settings/settings",style:{navigationBarTitleText:"设置"}},{path:"pages/ucenter/read-news-log/read-news-log",style:{navigationBarTitleText:"阅读记录",enablePullDownRefresh:!0}}],s={loginPage:"uni_modules/uni-id-pages/pages/login/login-withoutpwd",needLogin:["/uni_modules/uni-id-pages/pages/userinfo/userinfo"],resToLogin:!0},a=t.importObject("uni-id-co"),r=t.database().collection("uni-id-users");let u=e.getStorageSync("uni-id-pages-userInfo")||{};const l={userInfo:u,hasLogin:0!=Object.keys(u).length},g={async updateUserInfo(i=!1){if(i)r.where("_id==$env.uid").update(i).then((t=>{t.result.updated?(e.showToast({title:"更新成功",icon:"none",duration:3e3}),this.setUserInfo(i)):e.showToast({title:"没有改变",icon:"none",duration:3e3})}));else{const e=t.getCurrentUserInfo().uid;this.setUserInfo({_id:e},{cover:!0});const i=t.importObject("uni-id-co",{customUI:!0});try{let e=await r.where("'_id' == $cloudEnv_uid").field("mobile,nickname,username,email,avatar_file").get();const t=await i.getRealNameInfo();this.setUserInfo({...e.result.data[0],realNameAuth:t})}catch(n){this.setUserInfo({},{cover:!0}),console.error(n.message,n.errCode)}}},setUserInfo(t,{cover:i}={cover:!1}){let n=i?t:Object.assign(c.userInfo,t);return c.userInfo=Object.assign({},n),c.hasLogin=0!=Object.keys(c.userInfo).length,e.setStorageSync("uni-id-pages-userInfo",c.userInfo),t},async logout(){if(t.getCurrentUserInfo().tokenExpired>Date.now())try{await a.logout()}catch(i){console.error(i)}e.removeStorageSync("uni_id_token"),e.setStorageSync("uni_id_token_expired",0),this.setUserInfo({},{cover:!0}),e.$emit("uni-id-pages-logout"),e.redirectTo({url:`/${s&&s.loginPage?s.loginPage:"uni_modules/uni-id-pages/pages/login/login-withoutpwd"}`})},loginBack(t={}){const{uniIdRedirectUrl:i=""}=t;let n=0,s=e.getCurrentPages();if(s.forEach(((e,t)=>{"login"==s[s.length-t-1].route.split("/")[3]&&n++})),i)return e.redirectTo({url:i,fail:t=>{e.switchTab({url:i,fail:e=>{console.log(t,e)}})}});if("weixin"==t.loginType)return window.history.go(-3);if(n){const t=o[0];return e.reLaunch({url:`/${t.path}`})}e.navigateBack({delta:n})},loginSuccess(t={}){const{showToast:n=!0,toastText:o="登录成功",autoBack:s=!0,uniIdRedirectUrl:a="",passwordConfirmed:r}=t;if(n&&e.showToast({title:o,icon:"none",duration:3e3}),this.updateUserInfo(),e.$emit("uni-id-pages-login-success"),i.config$1.setPasswordAfterLogin&&!r)return e.redirectTo({url:a?`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?uniIdRedirectUrl=${a}&loginType=${t.loginType}`:`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?loginType=${t.loginType}`,fail:e=>{console.log(e)}});s&&this.loginBack({uniIdRedirectUrl:a})}},c=n.reactive(l);exports.mutations=g,exports.store=c;
