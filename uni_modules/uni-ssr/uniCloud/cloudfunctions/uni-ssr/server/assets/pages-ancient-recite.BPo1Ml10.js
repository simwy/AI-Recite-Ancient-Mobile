"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("@dcloudio/uni-h5"),t=require("@dcloudio/uni-cloud"),a=require("vue"),r=require("./_plugin-vue_export-helper.BDcHAK_d.js");require("@vue/shared");const s={data:()=>({id:"",textData:{},started:!1,recording:!1,duration:0,durationTimer:null,hintCount:0,hintCharCount:0,hints:[],recorderManager:null,socketTask:null,asrConfig:null,taskId:"",taskStarted:!1,taskFinished:!1,frameQueue:[],finalSentences:[],partialSentence:"",realtimeText:"",stopping:!1,waitTaskFinishedResolver:null,useWebRecorder:!1,webAudioContext:null,webMediaStream:null,webScriptProcessor:null,h5MediaRecorder:null,h5AudioChunks:[],h5StopPromiseResolver:null}),onLoad(t){this.id=t.id;const a=e.getApp();a.globalData&&a.globalData.currentText&&(this.textData=a.globalData.currentText),this.initRecorder()},onUnload(){clearInterval(this.durationTimer),this.cleanupH5PcmRecorder(),this.recording&&(this.useWebRecorder?this.stopWebRecorder():this.recorderManager&&this.recorderManager.stop()),this.closeSocket(),this.destroyWebRecorder()},methods:{initRecorder(){this.useWebRecorder=!0},async startRecite(){if(!this.recording)try{return this.resetRealtimeState(),this.started=!0,this.recording=!0,this.stopping=!1,this.duration=0,this.durationTimer=setInterval((()=>{this.duration++}),1e3),void(await this.startH5PcmRecorder())}catch(t){this.closeSocket(),e.showToast({title:t.message||"启动识别失败",icon:"none",duration:3e3}),console.error("启动实时识别失败:",t)}},showHint(){const t=this.getHintChars();if(0===t.length)return;if(this.hintCharCount>=t.length)return void e.showToast({title:"已无更多提示",icon:"none"});this.hintCharCount++;const a=t.slice(0,this.hintCharCount).join("")+"...";this.hints=[a],this.hintCount++},getHintChars(){return[...this.textData.content||""].filter((e=>/[\u4e00-\u9fff]/.test(e)))},stopRecite(){this.stopping=!0,this.recording=!1,clearInterval(this.durationTimer),this.stopH5PcmRecorder()},async handleRecorderStop(){this.stopping&&(e.showLoading({title:"正在结束识别..."}),await this.finishTask(),e.hideLoading(),this.goResult(this.realtimeText))},async loadAsrConfig(){const e=(await t.callFunction({name:"asr-config"})).result||{};if(0!==e.code||!e.data)throw new Error(e.msg||"获取语音配置失败");this.asrConfig=e.data},openSocket(){return new Promise(((t,a)=>{let r=this.asrConfig.wsUrl,s={Authorization:`${this.asrConfig.tokenType||"bearer"} ${this.asrConfig.temporaryToken}`};if(!window.isSecureContext)return void a(new Error("H5 录音需要 HTTPS 或 localhost 安全上下文"));const i=this.buildDefaultRelayWsUrl(),o=this.asrConfig.relayWsUrl||i;o?(r=o,s={},this.taskId=this.createTaskId(),this.socketTask=e.connectSocket({url:r,header:s,complete:()=>{}}),this.socketTask.onOpen((()=>{this.sendRunTask(),t()})),this.socketTask.onMessage((({data:e})=>{this.handleSocketMessage(e)})),this.socketTask.onError((e=>{a(new Error("H5 WebSocket 连接失败，请检查临时Token是否有效，以及当前浏览器是否允许在握手中携带鉴权头"))})),this.socketTask.onClose((()=>{this.socketTask=null}))):a(new Error("H5 需要配置 relayWsUrl，或确保当前站点可用 /asr-relay"))}))},sendRunTask(){if(!this.socketTask)return;const e={header:{action:"run-task",task_id:this.taskId,streaming:"duplex"},payload:{task_group:"audio",task:"asr",function:"recognition",model:this.asrConfig.model||"paraformer-realtime-v2",parameters:{format:this.asrConfig.format||"pcm",sample_rate:this.asrConfig.sampleRate||16e3,language_hints:this.asrConfig.languageHints||["zh"],punctuation_prediction_enabled:!1!==this.asrConfig.punctuationPredictionEnabled,inverse_text_normalization_enabled:!1!==this.asrConfig.inverseTextNormalizationEnabled},input:{}}};this.socketTask.send({data:JSON.stringify(e)})},sendAudioFrame(e){e&&this.socketTask&&(this.taskStarted?this.socketTask.send({data:e}):this.frameQueue.push(e))},flushFrameQueue(){if(this.socketTask&&this.taskStarted&&0!==this.frameQueue.length)for(;this.frameQueue.length>0;){const e=this.frameQueue.shift();this.socketTask.send({data:e})}},handleSocketMessage(e){const t=this.decodeSocketData(e);if(!t)return;let a=t;try{a=JSON.parse(t)}catch(i){return}const r=a.header||{},s=r.event;return"task-started"===s?(this.taskStarted=!0,void this.flushFrameQueue()):"result-generated"!==s?"task-finished"===s?(this.taskFinished=!0,this.waitTaskFinishedResolver&&(this.waitTaskFinishedResolver(),this.waitTaskFinishedResolver=null),void this.closeSocket()):void("task-failed"===s&&(console.error("任务失败:",r.error_message||"未知错误"),this.waitTaskFinishedResolver&&(this.waitTaskFinishedResolver(),this.waitTaskFinishedResolver=null),this.closeSocket())):void this.handleRecognizedSentence(a.payload&&a.payload.output&&a.payload.output.sentence)},decodeSocketData(e){if("string"==typeof e)return e;if(!(e instanceof ArrayBuffer))return"";if("undefined"!=typeof TextDecoder)return new TextDecoder("utf-8").decode(e);const t=new Uint8Array(e);let a="";for(let r=0;r<t.length;r++)a+=String.fromCharCode(t[r]);return decodeURIComponent(escape(a))},handleRecognizedSentence(e){if(!e||e.heartbeat)return;const t=e.text||"";t&&(e.sentence_end?(this.finalSentences.push(t),this.partialSentence=""):this.partialSentence=t,this.realtimeText=`${this.finalSentences.join("")}${this.partialSentence}`)},finishTask(){return new Promise((e=>{if(!this.socketTask)return void e();this.taskStarted&&!this.taskFinished&&this.socketTask.send({data:JSON.stringify({header:{action:"finish-task",task_id:this.taskId,streaming:"duplex"},payload:{input:{}}})});const t=setTimeout((()=>{this.closeSocket(),e()}),5e3);this.waitTaskFinishedResolver=()=>{clearTimeout(t),e()}}))},closeSocket(){if(this.socketTask){try{this.socketTask.close({})}catch(e){console.error("关闭 socket 失败:",e)}this.socketTask=null}},resetRealtimeState(){this.taskId="",this.taskStarted=!1,this.taskFinished=!1,this.frameQueue=[],this.finalSentences=[],this.partialSentence="",this.realtimeText="",this.waitTaskFinishedResolver=null},createTaskId:()=>`${Date.now()}-${Math.random().toString(16).slice(2,10)}`,buildDefaultRelayWsUrl(){if(!window.location||!window.location.host)return"";return`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/asr-relay`},async startWebRecorder(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("当前浏览器不支持录音");const e=this.asrConfig.sampleRate||16e3;this.webMediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.webAudioContext=new(window.AudioContext||window.webkitAudioContext);const t=this.webAudioContext.createMediaStreamSource(this.webMediaStream);this.webScriptProcessor=this.webAudioContext.createScriptProcessor(4096,1,1),this.webScriptProcessor.onaudioprocess=t=>{if(!this.recording||!this.socketTask)return;const a=t.inputBuffer.getChannelData(0),r=this.convertFloat32To16kPcm(a,this.webAudioContext.sampleRate,e);r&&r.byteLength>0&&this.sendAudioFrame(r)},t.connect(this.webScriptProcessor),this.webScriptProcessor.connect(this.webAudioContext.destination)},async startH5PcmRecorder(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("当前浏览器不支持录音");if("undefined"==typeof MediaRecorder)throw new Error("当前浏览器不支持 MediaRecorder");this.h5AudioChunks=[],this.webMediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.h5MediaRecorder=new MediaRecorder(this.webMediaStream,{mimeType:"audio/webm"}),this.h5MediaRecorder.ondataavailable=e=>{e.data&&e.data.size>0&&this.h5AudioChunks.push(e.data)},this.h5MediaRecorder.onstop=async()=>{if(this.stopping)try{e.showLoading({title:"语音识别中..."});const a=new Blob(this.h5AudioChunks,{type:"audio/webm"}),r=await this.blobToBase64(a),s=(await t.callFunction({name:"asr-file-recognize",data:{audioBase64:r,format:"webm"}})).result||{};if(0!==s.code)throw new Error(s.msg||"识别失败");this.realtimeText=s.data&&s.data.text||"",this.goResult(this.realtimeText)}catch(a){e.showToast({title:a.message||"识别失败",icon:"none"}),console.error("H5 文件识别失败:",a)}finally{e.hideLoading(),this.cleanupH5PcmRecorder(),this.h5StopPromiseResolver&&(this.h5StopPromiseResolver(),this.h5StopPromiseResolver=null)}},this.h5MediaRecorder.start()},async stopH5PcmRecorder(){this.h5MediaRecorder&&"inactive"!==this.h5MediaRecorder.state?await new Promise((e=>{this.h5StopPromiseResolver=e,this.h5MediaRecorder.stop()})):this.cleanupH5PcmRecorder()},cleanupH5PcmRecorder(){this.webMediaStream&&this.webMediaStream.getTracks().forEach((e=>e.stop())),this.webMediaStream=null,this.h5MediaRecorder=null,this.h5AudioChunks=[],this.h5StopPromiseResolver=null},blobToBase64:e=>new Promise(((t,a)=>{const r=new FileReader;r.onload=()=>{const e=r.result||"",a=String(e).split(",")[1]||"";t(a)},r.onerror=a,r.readAsDataURL(e)})),stopWebRecorder(){this.webScriptProcessor&&(this.webScriptProcessor.disconnect(),this.webScriptProcessor.onaudioprocess=null),this.webMediaStream&&this.webMediaStream.getTracks().forEach((e=>e.stop())),this.webAudioContext&&this.webAudioContext.close(),this.webScriptProcessor=null,this.webMediaStream=null,this.webAudioContext=null},destroyWebRecorder(){this.stopWebRecorder()},convertFloat32To16kPcm(e,t,a){if(!e||0===e.length)return null;const r=t/a,s=Math.max(1,Math.floor(e.length/r)),i=new Int16Array(s);let o=0,n=0;for(;o<s;){const t=Math.floor((o+1)*r);let a=0,s=0;for(let r=n;r<t&&r<e.length;r++)a+=e[r],s++;const c=s>0?a/s:0,d=Math.max(-1,Math.min(1,c));i[o]=d<0?32768*d:32767*d,o++,n=t}return i.buffer},goResult(t){e.getApp().globalData=e.getApp().globalData||{},e.getApp().globalData.reciteResult={textData:this.textData,recognizedText:t,hintCount:this.hintCount,duration:Number(this.duration)||0},e.redirectTo({url:`/pages/ancient/result?id=${this.id}`})},formatTime(e){const t=Math.floor(e/60),a=e%60;return`${String(t).padStart(2,"0")}:${String(a).padStart(2,"0")}`}}};const i=s.setup;s.setup=(e,t)=>{const r=a.useSSRContext();return(r.modules||(r.modules=new Set)).add("pages/ancient/recite.vue"),i?i(e,t):void 0};const o=r._export_sfc(s,[["ssrRender",function(t,s,i,o,n,c,d,l){const h=e.View,u=e.Text,p=e.Button;s(r.ssrRenderComponent(h,a.mergeProps({class:"container"},o),{default:a.withCtx(((e,t,s,i)=>{if(!t)return[a.createVNode(h,{class:"title-bar"},{default:a.withCtx((()=>[a.createVNode(u,{class:"title"},{default:a.withCtx((()=>[a.createTextVNode(a.toDisplayString(d.textData.title),1)])),_:1}),a.createVNode(u,{class:"meta"},{default:a.withCtx((()=>[a.createTextVNode(a.toDisplayString(d.textData.dynasty)+" · "+a.toDisplayString(d.textData.author),1)])),_:1})])),_:1}),d.hints.length>0?(a.openBlock(),a.createBlock(h,{key:0,class:"hint-area"},{default:a.withCtx((()=>[a.createVNode(h,{class:"hint-label"},{default:a.withCtx((()=>[a.createTextVNode("提示内容：")])),_:1}),a.createVNode(h,{class:"hint-content"},{default:a.withCtx((()=>[(a.openBlock(!0),a.createBlock(a.Fragment,null,a.renderList(d.hints,((e,t)=>(a.openBlock(),a.createBlock(u,{key:t,class:"hint-text"},{default:a.withCtx((()=>[a.createTextVNode(a.toDisplayString(e),1)])),_:2},1024)))),128))])),_:1})])),_:1})):a.createCommentVNode("",!0),a.createVNode(h,{class:"status-area"},{default:a.withCtx((()=>[d.recording?(a.openBlock(),a.createBlock(h,{key:0,class:"recording-indicator"},{default:a.withCtx((()=>[a.createVNode(u,{class:"recording-dot"},{default:a.withCtx((()=>[a.createTextVNode("●")])),_:1}),a.createVNode(u,{class:"recording-text"},{default:a.withCtx((()=>[a.createTextVNode("录音中... "+a.toDisplayString(l.formatTime(d.duration)),1)])),_:1})])),_:1})):d.started?(a.openBlock(),a.createBlock(h,{key:2,class:"status-text"},{default:a.withCtx((()=>[a.createVNode(u,null,{default:a.withCtx((()=>[a.createTextVNode("正在处理录音...")])),_:1})])),_:1})):(a.openBlock(),a.createBlock(h,{key:1,class:"status-text"},{default:a.withCtx((()=>[a.createVNode(u,null,{default:a.withCtx((()=>[a.createTextVNode("准备好后点击开始背诵")])),_:1})])),_:1}))])),_:1}),d.started?(a.openBlock(),a.createBlock(h,{key:1,class:"recognized-area"},{default:a.withCtx((()=>[a.createVNode(h,{class:"recognized-label"},{default:a.withCtx((()=>[a.createTextVNode("实时识别：")])),_:1}),a.createVNode(u,{class:"recognized-text"},{default:a.withCtx((()=>[a.createTextVNode(a.toDisplayString(d.realtimeText||"等待识别结果..."),1)])),_:1})])),_:1})):a.createCommentVNode("",!0),a.createVNode(h,{class:"action-area"},{default:a.withCtx((()=>[d.started?a.createCommentVNode("",!0):(a.openBlock(),a.createBlock(p,{key:0,type:"primary",class:"btn",onClick:l.startRecite},{default:a.withCtx((()=>[a.createTextVNode("开始背诵")])),_:1},8,["onClick"])),d.recording?(a.openBlock(),a.createBlock(p,{key:1,type:"warn",class:"btn",onClick:l.stopRecite},{default:a.withCtx((()=>[a.createTextVNode(" 背诵结束 ")])),_:1},8,["onClick"])):a.createCommentVNode("",!0)])),_:1})];t(r.ssrRenderComponent(h,{class:"title-bar"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[a.createVNode(u,{class:"title"},{default:a.withCtx((()=>[a.createTextVNode(a.toDisplayString(d.textData.title),1)])),_:1}),a.createVNode(u,{class:"meta"},{default:a.withCtx((()=>[a.createTextVNode(a.toDisplayString(d.textData.dynasty)+" · "+a.toDisplayString(d.textData.author),1)])),_:1})];t(r.ssrRenderComponent(u,{class:"title"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[a.createTextVNode(a.toDisplayString(d.textData.title),1)];t(`${r.ssrInterpolate(d.textData.title)}`)})),_:1},s,i)),t(r.ssrRenderComponent(u,{class:"meta"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[a.createTextVNode(a.toDisplayString(d.textData.dynasty)+" · "+a.toDisplayString(d.textData.author),1)];t(`${r.ssrInterpolate(d.textData.dynasty)} · ${r.ssrInterpolate(d.textData.author)}`)})),_:1},s,i))})),_:1},s,i)),d.hints.length>0?t(r.ssrRenderComponent(h,{class:"hint-area"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[a.createVNode(h,{class:"hint-label"},{default:a.withCtx((()=>[a.createTextVNode("提示内容：")])),_:1}),a.createVNode(h,{class:"hint-content"},{default:a.withCtx((()=>[(a.openBlock(!0),a.createBlock(a.Fragment,null,a.renderList(d.hints,((e,t)=>(a.openBlock(),a.createBlock(u,{key:t,class:"hint-text"},{default:a.withCtx((()=>[a.createTextVNode(a.toDisplayString(e),1)])),_:2},1024)))),128))])),_:1})];t(r.ssrRenderComponent(h,{class:"hint-label"},{default:a.withCtx(((e,t,r,s)=>{if(!t)return[a.createTextVNode("提示内容：")];t("提示内容：")})),_:1},s,i)),t(r.ssrRenderComponent(h,{class:"hint-content"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[(a.openBlock(!0),a.createBlock(a.Fragment,null,a.renderList(d.hints,((e,t)=>(a.openBlock(),a.createBlock(u,{key:t,class:"hint-text"},{default:a.withCtx((()=>[a.createTextVNode(a.toDisplayString(e),1)])),_:2},1024)))),128))];t("\x3c!--[--\x3e"),r.ssrRenderList(d.hints,((e,o)=>{t(r.ssrRenderComponent(u,{key:o,class:"hint-text"},{default:a.withCtx(((t,s,i,o)=>{if(!s)return[a.createTextVNode(a.toDisplayString(e),1)];s(`${r.ssrInterpolate(e)}`)})),_:2},s,i))})),t("\x3c!--]--\x3e")})),_:1},s,i))})),_:1},s,i)):t("\x3c!----\x3e"),t(r.ssrRenderComponent(h,{class:"status-area"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[d.recording?(a.openBlock(),a.createBlock(h,{key:0,class:"recording-indicator"},{default:a.withCtx((()=>[a.createVNode(u,{class:"recording-dot"},{default:a.withCtx((()=>[a.createTextVNode("●")])),_:1}),a.createVNode(u,{class:"recording-text"},{default:a.withCtx((()=>[a.createTextVNode("录音中... "+a.toDisplayString(l.formatTime(d.duration)),1)])),_:1})])),_:1})):d.started?(a.openBlock(),a.createBlock(h,{key:2,class:"status-text"},{default:a.withCtx((()=>[a.createVNode(u,null,{default:a.withCtx((()=>[a.createTextVNode("正在处理录音...")])),_:1})])),_:1})):(a.openBlock(),a.createBlock(h,{key:1,class:"status-text"},{default:a.withCtx((()=>[a.createVNode(u,null,{default:a.withCtx((()=>[a.createTextVNode("准备好后点击开始背诵")])),_:1})])),_:1}))];d.recording?t(r.ssrRenderComponent(h,{class:"recording-indicator"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[a.createVNode(u,{class:"recording-dot"},{default:a.withCtx((()=>[a.createTextVNode("●")])),_:1}),a.createVNode(u,{class:"recording-text"},{default:a.withCtx((()=>[a.createTextVNode("录音中... "+a.toDisplayString(l.formatTime(d.duration)),1)])),_:1})];t(r.ssrRenderComponent(u,{class:"recording-dot"},{default:a.withCtx(((e,t,r,s)=>{if(!t)return[a.createTextVNode("●")];t("●")})),_:1},s,i)),t(r.ssrRenderComponent(u,{class:"recording-text"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[a.createTextVNode("录音中... "+a.toDisplayString(l.formatTime(d.duration)),1)];t(`录音中... ${r.ssrInterpolate(l.formatTime(d.duration))}`)})),_:1},s,i))})),_:1},s,i)):d.started?t(r.ssrRenderComponent(h,{class:"status-text"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[a.createVNode(u,null,{default:a.withCtx((()=>[a.createTextVNode("正在处理录音...")])),_:1})];t(r.ssrRenderComponent(u,null,{default:a.withCtx(((e,t,r,s)=>{if(!t)return[a.createTextVNode("正在处理录音...")];t("正在处理录音...")})),_:1},s,i))})),_:1},s,i)):t(r.ssrRenderComponent(h,{class:"status-text"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[a.createVNode(u,null,{default:a.withCtx((()=>[a.createTextVNode("准备好后点击开始背诵")])),_:1})];t(r.ssrRenderComponent(u,null,{default:a.withCtx(((e,t,r,s)=>{if(!t)return[a.createTextVNode("准备好后点击开始背诵")];t("准备好后点击开始背诵")})),_:1},s,i))})),_:1},s,i))})),_:1},s,i)),d.started?t(r.ssrRenderComponent(h,{class:"recognized-area"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[a.createVNode(h,{class:"recognized-label"},{default:a.withCtx((()=>[a.createTextVNode("实时识别：")])),_:1}),a.createVNode(u,{class:"recognized-text"},{default:a.withCtx((()=>[a.createTextVNode(a.toDisplayString(d.realtimeText||"等待识别结果..."),1)])),_:1})];t(r.ssrRenderComponent(h,{class:"recognized-label"},{default:a.withCtx(((e,t,r,s)=>{if(!t)return[a.createTextVNode("实时识别：")];t("实时识别：")})),_:1},s,i)),t(r.ssrRenderComponent(u,{class:"recognized-text"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[a.createTextVNode(a.toDisplayString(d.realtimeText||"等待识别结果..."),1)];t(`${r.ssrInterpolate(d.realtimeText||"等待识别结果...")}`)})),_:1},s,i))})),_:1},s,i)):t("\x3c!----\x3e"),t(r.ssrRenderComponent(h,{class:"action-area"},{default:a.withCtx(((e,t,s,i)=>{if(!t)return[d.started?a.createCommentVNode("",!0):(a.openBlock(),a.createBlock(p,{key:0,type:"primary",class:"btn",onClick:l.startRecite},{default:a.withCtx((()=>[a.createTextVNode("开始背诵")])),_:1},8,["onClick"])),d.recording?(a.openBlock(),a.createBlock(p,{key:1,type:"warn",class:"btn",onClick:l.stopRecite},{default:a.withCtx((()=>[a.createTextVNode(" 背诵结束 ")])),_:1},8,["onClick"])):a.createCommentVNode("",!0)];d.started?t("\x3c!----\x3e"):t(r.ssrRenderComponent(p,{type:"primary",class:"btn",onClick:l.startRecite},{default:a.withCtx(((e,t,r,s)=>{if(!t)return[a.createTextVNode("开始背诵")];t("开始背诵")})),_:1},s,i)),d.recording?t(r.ssrRenderComponent(p,{type:"warn",class:"btn",onClick:l.stopRecite},{default:a.withCtx(((e,t,r,s)=>{if(!t)return[a.createTextVNode(" 背诵结束 ")];t(" 背诵结束 ")})),_:1},s,i)):t("\x3c!----\x3e")})),_:1},s,i))})),_:1},i))}],["__scopeId","data-v-26102e5c"]]);exports.default=o;
